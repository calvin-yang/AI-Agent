{% extends "base.html" %}

{% block title %}AI Agent - æ™ºèƒ½åŠ©æ‰‹{% endblock %}

{% block content %}
<div class="d-flex flex-column h-100">
    <!-- å¤´éƒ¨ -->
    <div class="p-3 border-bottom">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h4 class="mb-0">
                <i class="fas fa-robot text-primary me-2"></i>
                AI Agent æ™ºèƒ½åŠ©æ‰‹
            </h4>
            <span id="connectionStatus" class="badge bg-warning">
                <i class="fas fa-circle text-warning me-1"></i>è¿æ¥ä¸­...
            </span>
        </div>
        <p class="text-muted text-center mb-0">æ”¯æŒè”ç½‘æœç´¢çš„æ™ºèƒ½é—®ç­”ç³»ç»Ÿ</p>
    </div>
    
    <!-- èŠå¤©åŒºåŸŸ -->
    <div class="flex-grow-1 p-3 overflow-auto" id="chatArea" style="height: 400px;">
        <div class="message ai-message">
            <div class="message-content">
                <i class="fas fa-robot me-2"></i>
                <div class="markdown-content">
                    # æ‚¨å¥½ï¼æˆ‘æ˜¯AIæ™ºèƒ½åŠ©æ‰‹ ğŸ¤–
                    
                    æˆ‘å¯ä»¥å¸®æ‚¨å›ç­”é—®é¢˜ï¼Œå¹¶æ ¹æ®é—®é¢˜çš„éœ€è¦è‡ªåŠ¨è¿›è¡Œè”ç½‘æœç´¢æ¥è·å–æœ€æ–°ä¿¡æ¯ã€‚
                    
                    ## åŠŸèƒ½ç‰¹ç‚¹
                    
                    - **æ™ºèƒ½åˆ¤æ–­**ï¼šè‡ªåŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦è”ç½‘æœç´¢
                    - **å¤šå¼•æ“æœç´¢**ï¼šæ”¯æŒDuckDuckGoå’ŒGoogleæœç´¢
                    - **å†…å®¹åˆ†æ**ï¼šè‡ªåŠ¨çˆ¬å–ç½‘é¡µå†…å®¹è¿›è¡Œåˆ†æ
                    - **å‡†ç¡®å›ç­”**ï¼šæä¾›å‡†ç¡®ã€åŠæ—¶çš„å›ç­”
                    
                    ## ä½¿ç”¨æç¤º
                    
                    æ‚¨å¯ä»¥é—®æˆ‘ä»»ä½•é—®é¢˜ï¼Œæ¯”å¦‚ï¼š
                    - æœ€æ–°çš„æ–°é—»èµ„è®¯
                    - æŠ€æœ¯é—®é¢˜è§£ç­”
                    - å®æ—¶æ•°æ®æŸ¥è¯¢
                    - å†å²çŸ¥è¯†é—®ç­”
                </div>
            </div>
        </div>
    </div>
    
    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="p-3 border-top">
        <form id="chatForm">
            <div class="input-group">
                <input type="text" class="form-control" id="questionInput" 
                       placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." autocomplete="off" required>
                <button class="btn btn-send" type="submit" id="sendBtn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </form>
        
        <!-- æœç´¢å»ºè®® -->
        <div id="suggestions" class="mt-2" style="display: none;">
            <small class="text-muted">æœç´¢å»ºè®®ï¼š</small>
            <div id="suggestionList"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatArea = document.getElementById('chatArea');
    const questionInput = document.getElementById('questionInput');
    const chatForm = document.getElementById('chatForm');
    const sendBtn = document.getElementById('sendBtn');
    const suggestions = document.getElementById('suggestions');
    const suggestionList = document.getElementById('suggestionList');
    
    // åˆå§‹åŒ–SocketIOè¿æ¥ï¼Œåªä½¿ç”¨WebSocket
    const socket = io({
        transports: ['websocket'],
        upgrade: false,
        rememberUpgrade: false
    });
    let sessionId = null;
    let currentTaskId = null;
    
    // SocketIOäº‹ä»¶ç›‘å¬
    socket.on('connect', function() {
        console.log('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
        updateConnectionStatus('connected');
    });
    
    socket.on('disconnect', function() {
        console.log('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
        updateConnectionStatus('disconnected');
        sessionId = null;
    });
    
    socket.on('connected', function(data) {
        sessionId = data.session_id;
        console.log('ä¼šè¯ID:', sessionId);
        updateConnectionStatus('ready');
    });
    
    socket.on('task_started', function(data) {
        showTypingIndicator(data.status);
    });
    
    socket.on('task_update', function(data) {
        updateTaskProgress(data);
    });
    
    socket.on('error', function(data) {
        hideTypingIndicator();
        addMessage('é”™è¯¯: ' + data.message, 'ai');
    });
    
    // å‘é€æ¶ˆæ¯
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const question = questionInput.value.trim();
        if (question && sessionId) {
            sendMessageAsync(question);
            questionInput.value = '';
            const suggestionsContainer = document.getElementById('suggestions');
            suggestionsContainer.style.display = 'none';
        } else if (!sessionId) {
            addMessage('æ­£åœ¨è¿æ¥æœåŠ¡å™¨ï¼Œè¯·ç¨å€™...', 'ai');
        }
    });
    
    // è¾“å…¥æ¡†å˜åŒ–æ—¶è·å–å»ºè®®
    let suggestionTimeout;
    let lastSuggestionQuery = '';
    questionInput.addEventListener('input', function() {
        const question = this.value.trim();
        if (question.length > 3 && question !== lastSuggestionQuery) {
            clearTimeout(suggestionTimeout);
            suggestionTimeout = setTimeout(() => {
                getSuggestions(question);
                lastSuggestionQuery = question;
            }, 800); // å¢åŠ å»¶è¿Ÿï¼Œå‡å°‘è¯·æ±‚é¢‘ç‡
        } else if (question.length <= 3) {
            const suggestionsContainer = document.getElementById('suggestions');
            suggestionsContainer.style.display = 'none';
            lastSuggestionQuery = '';
        }
    });
    
    function sendMessageAsync(question) {
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        addMessage(question, 'user');
        
        // ç«‹å³æ˜¾ç¤ºloadingçŠ¶æ€åœ¨èŠå¤©åŒºåŸŸ
        showTypingIndicator('æ­£åœ¨åˆ†ææ‚¨çš„é—®é¢˜...');
        
        // ç¦ç”¨å‘é€æŒ‰é’®
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        // é€šè¿‡SocketIOå‘é€é—®é¢˜
        socket.emit('ask_question', {
            question: question,
            session_id: sessionId
        });
    }
    
    function updateTaskProgress(data) {
        if (data.state === 'PROGRESS') {
            // æ›´æ–°è¿›åº¦
            updateTypingIndicator(data.status, data.progress);
        } else if (data.state === 'SUCCESS') {
            // ä»»åŠ¡å®Œæˆ
            hideTypingIndicator();
            if (data.result) {
                addMessage(data.result.answer, 'ai', data.result);
            }
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        } else if (data.state === 'FAILURE') {
            // ä»»åŠ¡å¤±è´¥
            hideTypingIndicator();
            addMessage('æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„é—®é¢˜æ—¶å‡ºç°äº†é”™è¯¯ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'ai');
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        }
    }
    
    function addMessage(content, type, metadata = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}-message`;
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        
        if (type === 'user') {
            contentDiv.innerHTML = `<i class="fas fa-user me-2"></i>${escapeHtml(content)}`;
        } else {
            // æ¸²æŸ“Markdownå†…å®¹
            const renderedContent = renderMarkdown(content);
            let html = `<i class="fas fa-robot me-2"></i><div class="markdown-content">${renderedContent}</div>`;
            
            // æ·»åŠ æœç´¢ä¿¡æ¯
            if (metadata && metadata.search_performed) {
                html += `<div class="search-info">
                    <i class="fas fa-search me-1"></i>
                    å·²è¿›è¡Œè”ç½‘æœç´¢ï¼Œå…³é”®è¯ï¼š${escapeHtml(metadata.search_keywords)}
                </div>`;
                
                // æ·»åŠ æ¥æºé“¾æ¥
                if (metadata.sources && metadata.sources.length > 0) {
                    html += '<div class="sources"><strong>å‚è€ƒæ¥æºï¼š</strong>';
                    metadata.sources.slice(0, 3).forEach(source => {
                        if (source.url) {
                            html += `<div class="source-item">
                                <a href="${source.url}" target="_blank">${escapeHtml(source.title || source.url)}</a>
                            </div>`;
                        }
                    });
                    html += '</div>';
                }
            }
            
            contentDiv.innerHTML = html;
            
            // é«˜äº®ä»£ç å—
            if (typeof Prism !== 'undefined') {
                Prism.highlightAllUnder(contentDiv);
            }
        }
        
        messageDiv.appendChild(contentDiv);
        chatArea.appendChild(messageDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
    }
    
    function showTypingIndicator(status = 'æ­£åœ¨æ€è€ƒ...') {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message ai-message';
        typingDiv.id = 'typingIndicator';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'typing-indicator';
        contentDiv.innerHTML = `
            <i class="fas fa-robot me-2"></i>
            <span class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </span>
            <span class="ms-2">${status}</span>
        `;
        
        typingDiv.appendChild(contentDiv);
        chatArea.appendChild(typingDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
    }
    
    function updateTypingIndicator(status, progress) {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            const contentDiv = typingIndicator.querySelector('.typing-indicator');
            contentDiv.innerHTML = `
                <i class="fas fa-robot me-2"></i>
                <span class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </span>
                <span class="ms-2">${status}</span>
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar" role="progressbar" style="width: ${progress}%"></div>
                </div>
            `;
        }
    }
    
    function hideTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }
    
    function updateConnectionStatus(status) {
        const statusElement = document.getElementById('connectionStatus');
        if (statusElement) {
            switch(status) {
                case 'connected':
                    statusElement.innerHTML = '<i class="fas fa-circle text-warning me-1"></i>è¿æ¥ä¸­...';
                    statusElement.className = 'badge bg-warning';
                    break;
                case 'ready':
                    statusElement.innerHTML = '<i class="fas fa-circle text-success me-1"></i>å·²è¿æ¥';
                    statusElement.className = 'badge bg-success';
                    break;
                case 'disconnected':
                    statusElement.innerHTML = '<i class="fas fa-circle text-danger me-1"></i>è¿æ¥æ–­å¼€';
                    statusElement.className = 'badge bg-danger';
                    break;
            }
        }
    }
    
    function getSuggestions(question) {
        const suggestionsContainer = document.getElementById('suggestions');
        const suggestionListElement = document.getElementById('suggestionList');
        
        // æ˜¾ç¤ºå»ºè®®åŠ è½½çŠ¶æ€
        suggestionListElement.innerHTML = '<li class="list-group-item text-muted"><i class="fas fa-spinner fa-spin me-2"></i>æ­£åœ¨ç”Ÿæˆå»ºè®®...</li>';
        suggestionsContainer.style.display = 'block';
        
        fetch('/suggestions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ question: question })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.suggestions && data.suggestions.length > 0) {
                showSuggestions(data.suggestions);
            } else {
                // æ²¡æœ‰å»ºè®®æ—¶éšè—
                suggestionsContainer.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('è·å–å»ºè®®å¤±è´¥:', error);
            suggestionsContainer.style.display = 'none';
        });
    }
    
    function showSuggestions(suggestionList) {
        const suggestionsContainer = document.getElementById('suggestions');
        const suggestionListElement = document.getElementById('suggestionList');
        
        suggestionListElement.innerHTML = '';
        suggestionList.forEach(suggestion => {
            const suggestionDiv = document.createElement('div');
            suggestionDiv.className = 'badge bg-light text-dark me-1 mb-1';
            suggestionDiv.style.cursor = 'pointer';
            suggestionDiv.textContent = suggestion;
            suggestionDiv.addEventListener('click', function() {
                questionInput.value = suggestion;
                suggestionsContainer.style.display = 'none';
                questionInput.focus();
            });
            suggestionListElement.appendChild(suggestionDiv);
        });
        suggestionsContainer.style.display = 'block';
    }
    
    function renderMarkdown(text) {
        if (typeof marked !== 'undefined') {
            // é…ç½®markedé€‰é¡¹
            marked.setOptions({
                breaks: true,
                gfm: true,
                sanitize: false
            });
            return marked.parse(text);
        } else {
            // å¦‚æœmarkedåº“æœªåŠ è½½ï¼Œåˆ™ç®€å•è½¬ä¹‰HTML
            return escapeHtml(text);
        }
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // èšç„¦è¾“å…¥æ¡†
    questionInput.focus();
});
</script>
{% endblock %}
