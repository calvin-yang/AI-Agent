{% extends "base.html" %}

{% block title %}AI Agent - æ™ºèƒ½åŠ©æ‰‹{% endblock %}

{% block content %}
<div class="d-flex h-100">
    <!-- å·¦ä¾§ä¼šè¯å†å²é¢æ¿ -->
    <div class="sidebar bg-light border-end" id="sidebar" style="width: 300px; min-width: 300px;">
        <!-- ä¼šè¯é¢æ¿å¤´éƒ¨ -->
        <div class="p-3 border-bottom">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">
                    <i class="fas fa-comments me-2"></i>
                    ä¼šè¯å†å²
                </h6>
                <button class="btn btn-outline-primary btn-sm" id="newChatBtn">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div id="walletSection">
                <button id="connectWalletBtn" class="btn btn-outline-primary btn-sm w-100">
                    <i class="fas fa-wallet me-1"></i>è¿æ¥é’±åŒ…
                </button>
                <div id="walletInfo" class="d-none">
                    <div class="d-flex align-items-center justify-content-between">
                        <span class="badge bg-success">
                            <i class="fas fa-check-circle me-1"></i>
                            <span id="walletAddress"></span>
                        </span>
                        <button id="disconnectWalletBtn" class="btn btn-outline-danger btn-sm">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ä¼šè¯åˆ—è¡¨ -->
        <div class="flex-grow-1 overflow-auto" id="sessionList" style="height: calc(100vh - 200px);">
            <div class="p-3">
                <div id="sessionItems">
                    <!-- ä¼šè¯é¡¹ç›®å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
        
        <!-- ä¼šè¯é¢æ¿åº•éƒ¨ -->
        <div class="p-3 border-top">
            <div class="d-flex align-items-center justify-content-between">
                <span id="connectionStatus" class="badge bg-warning">
                    <i class="fas fa-circle text-warning me-1"></i>è¿æ¥ä¸­...
                </span>
                <small class="text-muted">AI Agent v2.0</small>
            </div>
        </div>
    </div>
    
    <!-- å³ä¾§èŠå¤©åŒºåŸŸ -->
    <div class="flex-grow-1 d-flex flex-column">
        <!-- èŠå¤©å¤´éƒ¨ -->
        <div class="p-3 border-bottom">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0" id="currentSessionTitle">
                        <i class="fas fa-robot text-primary me-2"></i>
                        AI Agent æ™ºèƒ½åŠ©æ‰‹
                    </h5>
                    <small class="text-muted">æ”¯æŒè”ç½‘æœç´¢çš„æ™ºèƒ½é—®ç­”ç³»ç»Ÿ</small>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" id="sessionSettingsBtn" style="display: none;">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" id="clearChatBtn" style="display: none;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- èŠå¤©åŒºåŸŸ -->
        <div class="flex-grow-1 p-3 overflow-auto" id="chatArea" style="height: calc(100vh - 200px);">
            <div class="message ai-message" id="welcomeMessage">
                <div class="message-content">
                    <i class="fas fa-robot me-2"></i>
                    <div class="markdown-content">
                        # æ‚¨å¥½ï¼æˆ‘æ˜¯AIæ™ºèƒ½åŠ©æ‰‹ ğŸ¤–
                        
                        æˆ‘å¯ä»¥å¸®æ‚¨å›ç­”é—®é¢˜ï¼Œå¹¶æ ¹æ®é—®é¢˜çš„éœ€è¦è‡ªåŠ¨è¿›è¡Œè”ç½‘æœç´¢æ¥è·å–æœ€æ–°ä¿¡æ¯ã€‚
                        
                        ## åŠŸèƒ½ç‰¹ç‚¹
                        
                        - **æ™ºèƒ½åˆ¤æ–­**ï¼šè‡ªåŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦è”ç½‘æœç´¢
                        - **å¤šå¼•æ“æœç´¢**ï¼šæ”¯æŒDuckDuckGoå’ŒGoogleæœç´¢
                        - **å†…å®¹åˆ†æ**ï¼šè‡ªåŠ¨çˆ¬å–ç½‘é¡µå†…å®¹è¿›è¡Œåˆ†æ
                        - **å‡†ç¡®å›ç­”**ï¼šæä¾›å‡†ç¡®ã€åŠæ—¶çš„å›ç­”
                        - **ä¼šè¯ç®¡ç†**ï¼šæ”¯æŒå¤šä¼šè¯å†å²è®°å½•
                        
                        ## ä½¿ç”¨æç¤º
                        
                        æ‚¨å¯ä»¥é—®æˆ‘ä»»ä½•é—®é¢˜ï¼Œæ¯”å¦‚ï¼š
                        - æœ€æ–°çš„æ–°é—»èµ„è®¯
                        - æŠ€æœ¯é—®é¢˜è§£ç­”
                        - å®æ—¶æ•°æ®æŸ¥è¯¢
                        - å†å²çŸ¥è¯†é—®ç­”
                        
                        ## æ–°åŠŸèƒ½
                        
                        - ç‚¹å‡»å·¦ä¾§"+"æŒ‰é’®åˆ›å»ºæ–°ä¼šè¯
                        - å·¦ä¾§é¢æ¿æ˜¾ç¤ºæ‰€æœ‰ä¼šè¯å†å²
                        - è¿æ¥é’±åŒ…åå¯æ°¸ä¹…ä¿å­˜ä¼šè¯è®°å½•
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="p-3 border-top">
            <form id="chatForm">
                <div class="input-group">
                    <input type="text" class="form-control" id="questionInput" 
                           placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." autocomplete="off" required>
                    <button class="btn btn-send" type="submit" id="sendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </form>
            
            <!-- æœç´¢å»ºè®® -->
            <div id="suggestions" class="mt-2" style="display: none;">
                <small class="text-muted">æœç´¢å»ºè®®ï¼š</small>
                <div id="suggestionList"></div>
            </div>
        </div>
    </div>
</div>

<!-- è‡ªå®šä¹‰é’±åŒ…è¿æ¥æ¨¡æ€æ¡† -->
<div id="walletModal" class="custom-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background: rgba(0,0,0,0.5);">
    <div class="custom-modal-dialog" style="position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 500px; width: 90%; z-index: 10000;">
        <div class="custom-modal-content" style="background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 10001;">
            <div class="custom-modal-header" style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                <h5 style="margin: 0; font-weight: 600;">
                    <i class="fas fa-wallet me-2"></i>è¿æ¥é’±åŒ…
                </h5>
                <button type="button" class="btn-close" id="closeWalletModal" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            <div class="custom-modal-body" style="padding: 20px;">
                <div class="text-center mb-4">
                    <p class="text-muted">é€‰æ‹©æ‚¨çš„é’±åŒ…è¿›è¡Œè¿æ¥</p>
                </div>
                <div class="d-grid gap-3">
                    <button class="btn btn-outline-primary btn-lg" id="connectMetaMask" style="pointer-events: auto; cursor: pointer;">
                        <i class="fab fa-ethereum me-2"></i>
                        MetaMask
                    </button>
                    <button class="btn btn-outline-success btn-lg" id="connectOKX" style="pointer-events: auto; cursor: pointer;">
                        <i class="fas fa-wallet me-2"></i>
                        OKX Wallet
                    </button>
                </div>
                <div class="mt-4">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>è¿æ¥é’±åŒ…åï¼Œæ‚¨å°†èƒ½å¤Ÿäº«å—ä¸ªæ€§åŒ–çš„AIæœåŠ¡ä½“éªŒ</small>
                    </div>
                </div>
            </div>
            <div class="custom-modal-footer" style="padding: 20px; border-top: 1px solid #eee; text-align: right;">
                <button type="button" class="btn btn-secondary" id="cancelWalletModal">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
</div>

<!-- ç­¾åç¡®è®¤æ¨¡æ€æ¡† -->
<div class="modal fade" id="signModal" tabindex="-1" aria-labelledby="signModalLabel" aria-hidden="true" style="z-index: 1055;">
    <div class="modal-dialog modal-dialog-centered" style="pointer-events: auto; z-index: 1056; position: relative;">
        <div class="modal-content" style="pointer-events: auto; z-index: 1057; position: relative;">
            <div class="modal-header">
                <h5 class="modal-title" id="signModalLabel">
                    <i class="fas fa-signature me-2"></i>ç­¾åç¡®è®¤
                </h5>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">è¯·åœ¨æ‚¨çš„é’±åŒ…ä¸­ç¡®è®¤ç­¾å</p>
                </div>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <small>æ­¤ç­¾åä»…ç”¨äºèº«ä»½éªŒè¯ï¼Œä¸ä¼šäº§ç”Ÿä»»ä½•äº¤æ˜“è´¹ç”¨</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelSignBtn" style="pointer-events: auto;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatArea = document.getElementById('chatArea');
    const questionInput = document.getElementById('questionInput');
    const chatForm = document.getElementById('chatForm');
    const sendBtn = document.getElementById('sendBtn');
    const suggestions = document.getElementById('suggestions');
    const suggestionList = document.getElementById('suggestionList');
    
    // ä¼šè¯ç®¡ç†ç›¸å…³å…ƒç´ 
    const newChatBtn = document.getElementById('newChatBtn');
    const sessionList = document.getElementById('sessionList');
    const sessionItems = document.getElementById('sessionItems');
    const currentSessionTitle = document.getElementById('currentSessionTitle');
    const sessionSettingsBtn = document.getElementById('sessionSettingsBtn');
    const clearChatBtn = document.getElementById('clearChatBtn');
    
    // é’±åŒ…ç›¸å…³å…ƒç´ 
    const connectWalletBtn = document.getElementById('connectWalletBtn');
    const walletInfo = document.getElementById('walletInfo');
    const walletAddress = document.getElementById('walletAddress');
    const disconnectWalletBtn = document.getElementById('disconnectWalletBtn');
    const walletModalElement = document.getElementById('walletModal');
    const signModalElement = document.getElementById('signModal');
    const signModal = new bootstrap.Modal(signModalElement);
    const connectMetaMaskBtn = document.getElementById('connectMetaMask');
    const connectOKXBtn = document.getElementById('connectOKX');
    const cancelSignBtn = document.getElementById('cancelSignBtn');
    
    // é’±åŒ…çŠ¶æ€
    let currentWallet = null;
    let currentAccount = null;
    let authToken = localStorage.getItem('authToken');
    
    // ä¼šè¯çŠ¶æ€
    let currentSessionId = null;
    let currentSession = null;
    let sessions = [];
    
    // åˆå§‹åŒ–SocketIOè¿æ¥ï¼Œåªä½¿ç”¨WebSocket
    const socket = io({
        transports: ['websocket'],
        upgrade: false,
        rememberUpgrade: false
    });
    let currentTaskId = null;
    
    // SocketIOäº‹ä»¶ç›‘å¬
    socket.on('connect', function() {
        console.log('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
        updateConnectionStatus('connected');
    });
    
    socket.on('disconnect', function() {
        console.log('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
        updateConnectionStatus('disconnected');
        sessionId = null;
    });
    
    socket.on('connected', function(data) {
        console.log('SocketIOè¿æ¥æˆåŠŸ');
        updateConnectionStatus('ready');
        // åˆå§‹åŒ–ä¼šè¯ç®¡ç†
        initializeSessionManagement();
    });
    
    socket.on('task_started', function(data) {
        showTypingIndicator(data.status);
    });
    
    socket.on('task_update', function(data) {
        updateTaskProgress(data);
    });
    
    socket.on('error', function(data) {
        hideTypingIndicator();
        addMessage('é”™è¯¯: ' + data.message, 'ai');
    });
    
    socket.on('joined_session', function(data) {
        console.log('å·²åŠ å…¥ä¼šè¯æˆ¿é—´:', data.session_id);
    });
    
    socket.on('left_session', function(data) {
        console.log('å·²ç¦»å¼€ä¼šè¯æˆ¿é—´:', data.session_id);
    });
    
    // å‘é€æ¶ˆæ¯
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const question = questionInput.value.trim();
        if (question && currentSessionId) {
            sendMessageAsync(question);
            questionInput.value = '';
            const suggestionsContainer = document.getElementById('suggestions');
            suggestionsContainer.style.display = 'none';
        } else if (!currentSessionId) {
            addMessage('è¯·å…ˆåˆ›å»ºæˆ–é€‰æ‹©ä¸€ä¸ªä¼šè¯', 'ai');
        }
    });
    
    // æ–°ä¼šè¯æŒ‰é’®äº‹ä»¶
    newChatBtn.addEventListener('click', function() {
        createNewSession();
    });
    
    // æ¸…ç©ºèŠå¤©æŒ‰é’®äº‹ä»¶
    clearChatBtn.addEventListener('click', function() {
        if (currentSessionId) {
            clearCurrentSession();
        }
    });
    
    // è¾“å…¥æ¡†å˜åŒ–æ—¶è·å–å»ºè®®
    let suggestionTimeout;
    let lastSuggestionQuery = '';
    questionInput.addEventListener('input', function() {
        const question = this.value.trim();
        if (question.length > 3 && question !== lastSuggestionQuery) {
            clearTimeout(suggestionTimeout);
            suggestionTimeout = setTimeout(() => {
                getSuggestions(question);
                lastSuggestionQuery = question;
            }, 800); // å¢åŠ å»¶è¿Ÿï¼Œå‡å°‘è¯·æ±‚é¢‘ç‡
        } else if (question.length <= 3) {
            const suggestionsContainer = document.getElementById('suggestions');
            suggestionsContainer.style.display = 'none';
            lastSuggestionQuery = '';
        }
    });
    
    function sendMessageAsync(question) {
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
        addMessage(question, 'user');
        
        // æ›´æ–°å½“å‰ä¼šè¯çš„æ¶ˆæ¯åˆ—è¡¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (currentSession && currentSession.messages) {
            const newMessage = {
                message_type: 'user',
                content: question,
                metadata: null,
                created_at: new Date().toISOString()
            };
            currentSession.messages.push(newMessage);
            currentSession.message_count = currentSession.messages.length;
            currentSession.last_message_at = new Date().toISOString();
        }
        
        // ç«‹å³æ˜¾ç¤ºloadingçŠ¶æ€åœ¨èŠå¤©åŒºåŸŸ
        showTypingIndicator('æ­£åœ¨åˆ†ææ‚¨çš„é—®é¢˜...');
        
        // ç¦ç”¨å‘é€æŒ‰é’®
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        // é€šè¿‡APIå‘é€é—®é¢˜ï¼ˆæ–°æ–¹å¼ï¼‰
        fetch('/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': authToken ? `Bearer ${authToken}` : ''
            },
            body: JSON.stringify({
                question: question,
                session_id: currentSessionId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentTaskId = data.data.task_id;
                // ä»»åŠ¡å·²æäº¤ï¼Œç­‰å¾…SocketIOæ¨é€ç»“æœ
                console.log('ä»»åŠ¡å·²æäº¤ï¼Œç­‰å¾…ç»“æœæ¨é€:', currentTaskId);
            } else {
                hideTypingIndicator();
                addMessage('å‘é€å¤±è´¥: ' + data.error, 'ai');
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        })
        .catch(error => {
            console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
            hideTypingIndicator();
            addMessage('å‘é€å¤±è´¥: ' + error.message, 'ai');
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        });
    }
    
    function updateTaskProgress(data) {
        if (data.state === 'PROGRESS') {
            // æ›´æ–°è¿›åº¦
            updateTypingIndicator(data.status, data.progress);
        } else if (data.state === 'SUCCESS') {
            // ä»»åŠ¡å®Œæˆ
            hideTypingIndicator();
            if (data.result) {
                addMessage(data.result.answer, 'ai', data.result);
                
                // æ›´æ–°å½“å‰ä¼šè¯çš„æ¶ˆæ¯åˆ—è¡¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (currentSession && currentSession.messages) {
                    const newMessage = {
                        message_type: 'ai',
                        content: data.result.answer,
                        metadata: JSON.stringify(data.result),
                        created_at: new Date().toISOString()
                    };
                    currentSession.messages.push(newMessage);
                    currentSession.message_count = currentSession.messages.length;
                    currentSession.last_message_at = new Date().toISOString();
                }
            }
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        } else if (data.state === 'FAILURE') {
            // ä»»åŠ¡å¤±è´¥
            hideTypingIndicator();
            const errorMessage = 'æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„é—®é¢˜æ—¶å‡ºç°äº†é”™è¯¯ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯');
            addMessage(errorMessage, 'ai');
            
            // æ›´æ–°å½“å‰ä¼šè¯çš„æ¶ˆæ¯åˆ—è¡¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (currentSession && currentSession.messages) {
                const newMessage = {
                    message_type: 'ai',
                    content: errorMessage,
                    metadata: JSON.stringify({ error: data.error }),
                    created_at: new Date().toISOString()
                };
                currentSession.messages.push(newMessage);
                currentSession.message_count = currentSession.messages.length;
                currentSession.last_message_at = new Date().toISOString();
            }
            
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        }
    }
    
    function addMessage(content, type, metadata = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}-message`;
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        
        if (type === 'user') {
            contentDiv.innerHTML = `<i class="fas fa-user me-2"></i>${escapeHtml(content)}`;
        } else {
            // æ¸²æŸ“Markdownå†…å®¹
            const renderedContent = renderMarkdown(content);
            let html = `<i class="fas fa-robot me-2"></i><div class="markdown-content">${renderedContent}</div>`;
            
            // æ·»åŠ æœç´¢ä¿¡æ¯
            if (metadata && metadata.search_performed) {
                html += `<div class="search-info">
                    <i class="fas fa-search me-1"></i>
                    å·²è¿›è¡Œè”ç½‘æœç´¢ï¼Œå…³é”®è¯ï¼š${escapeHtml(metadata.search_keywords)}
                </div>`;
                
                // æ·»åŠ æ¥æºé“¾æ¥
                if (metadata.sources && metadata.sources.length > 0) {
                    html += '<div class="sources"><strong>å‚è€ƒæ¥æºï¼š</strong>';
                    metadata.sources.slice(0, 3).forEach(source => {
                        if (source.url) {
                            html += `<div class="source-item">
                                <a href="${source.url}" target="_blank">${escapeHtml(source.title || source.url)}</a>
                            </div>`;
                        }
                    });
                    html += '</div>';
                }
            }
            
            contentDiv.innerHTML = html;
            
            // é«˜äº®ä»£ç å—
            if (typeof Prism !== 'undefined') {
                Prism.highlightAllUnder(contentDiv);
            }
        }
        
        messageDiv.appendChild(contentDiv);
        chatArea.appendChild(messageDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
        
        // å¦‚æœæ˜¯æ–°æ¶ˆæ¯ï¼ˆä¸æ˜¯åŠ è½½å†å²æ¶ˆæ¯ï¼‰ï¼Œæ›´æ–°å½“å‰ä¼šè¯çš„æ¶ˆæ¯åˆ—è¡¨
        if (currentSession && type === 'user') {
            // ç”¨æˆ·æ¶ˆæ¯ä¼šåœ¨APIè°ƒç”¨æ—¶ä¿å­˜ï¼Œè¿™é‡Œä¸éœ€è¦é¢å¤–å¤„ç†
        } else if (currentSession && type === 'ai') {
            // AIæ¶ˆæ¯ä¼šåœ¨ä»»åŠ¡å®Œæˆæ—¶ä¿å­˜ï¼Œè¿™é‡Œä¸éœ€è¦é¢å¤–å¤„ç†
        }
    }
    
    function showTypingIndicator(status = 'æ­£åœ¨æ€è€ƒ...') {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message ai-message';
        typingDiv.id = 'typingIndicator';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'typing-indicator';
        contentDiv.innerHTML = `
            <i class="fas fa-robot me-2"></i>
            <span class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </span>
            <span class="ms-2">${status}</span>
        `;
        
        typingDiv.appendChild(contentDiv);
        chatArea.appendChild(typingDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
    }
    
    function updateTypingIndicator(status, progress) {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            const contentDiv = typingIndicator.querySelector('.typing-indicator');
            contentDiv.innerHTML = `
                <i class="fas fa-robot me-2"></i>
                <span class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </span>
                <span class="ms-2">${status}</span>
                <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar" role="progressbar" style="width: ${progress}%"></div>
                </div>
            `;
        }
    }
    
    function hideTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }
    
    function updateConnectionStatus(status) {
        const statusElement = document.getElementById('connectionStatus');
        if (statusElement) {
            switch(status) {
                case 'connected':
                    statusElement.innerHTML = '<i class="fas fa-circle text-warning me-1"></i>è¿æ¥ä¸­...';
                    statusElement.className = 'badge bg-warning';
                    break;
                case 'ready':
                    statusElement.innerHTML = '<i class="fas fa-circle text-success me-1"></i>å·²è¿æ¥';
                    statusElement.className = 'badge bg-success';
                    break;
                case 'disconnected':
                    statusElement.innerHTML = '<i class="fas fa-circle text-danger me-1"></i>è¿æ¥æ–­å¼€';
                    statusElement.className = 'badge bg-danger';
                    break;
            }
        }
    }
    
    function getSuggestions(question) {
        const suggestionsContainer = document.getElementById('suggestions');
        const suggestionListElement = document.getElementById('suggestionList');
        
        // æ˜¾ç¤ºå»ºè®®åŠ è½½çŠ¶æ€
        suggestionListElement.innerHTML = '<li class="list-group-item text-muted"><i class="fas fa-spinner fa-spin me-2"></i>æ­£åœ¨ç”Ÿæˆå»ºè®®...</li>';
        suggestionsContainer.style.display = 'block';
        
        fetch('/suggestions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ question: question })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.suggestions && data.suggestions.length > 0) {
                showSuggestions(data.suggestions);
            } else {
                // æ²¡æœ‰å»ºè®®æ—¶éšè—
                suggestionsContainer.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('è·å–å»ºè®®å¤±è´¥:', error);
            suggestionsContainer.style.display = 'none';
        });
    }
    
    function showSuggestions(suggestionList) {
        const suggestionsContainer = document.getElementById('suggestions');
        const suggestionListElement = document.getElementById('suggestionList');
        
        suggestionListElement.innerHTML = '';
        suggestionList.forEach(suggestion => {
            const suggestionDiv = document.createElement('div');
            suggestionDiv.className = 'badge bg-light text-dark me-1 mb-1';
            suggestionDiv.style.cursor = 'pointer';
            suggestionDiv.textContent = suggestion;
            suggestionDiv.addEventListener('click', function() {
                questionInput.value = suggestion;
                suggestionsContainer.style.display = 'none';
                questionInput.focus();
            });
            suggestionListElement.appendChild(suggestionDiv);
        });
        suggestionsContainer.style.display = 'block';
    }
    
    function renderMarkdown(text) {
        if (typeof marked !== 'undefined') {
            // é…ç½®markedé€‰é¡¹
            marked.setOptions({
                breaks: true,
                gfm: true,
                sanitize: false
            });
            return marked.parse(text);
        } else {
            // å¦‚æœmarkedåº“æœªåŠ è½½ï¼Œåˆ™ç®€å•è½¬ä¹‰HTML
            return escapeHtml(text);
        }
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // å¼ºåˆ¶ä¿®å¤æ¨¡æ€æ¡†ç‚¹å‡»é—®é¢˜ - ä½¿ç”¨æ›´æ¿€è¿›çš„æ–¹æ³•
    function fixModalClick() {
        console.log('å¼€å§‹ä¿®å¤æ¨¡æ€æ¡†ç‚¹å‡»é—®é¢˜');
        
        // æ–¹æ³•1: ç›´æ¥ç§»é™¤backdropçš„pointer-events
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => {
            backdrop.style.pointerEvents = 'none';
            backdrop.style.zIndex = '1050';
            console.log('ç§»é™¤backdrop pointer-events');
        });
        
        // æ–¹æ³•2: å¼ºåˆ¶è®¾ç½®æ¨¡æ€æ¡†å±‚çº§
        const modalDialogs = document.querySelectorAll('.modal-dialog');
        modalDialogs.forEach(dialog => {
            dialog.style.pointerEvents = 'auto';
            dialog.style.zIndex = '9999';
            dialog.style.position = 'relative';
            console.log('è®¾ç½®modal-dialog z-index: 9999');
        });
        
        // æ–¹æ³•3: å¼ºåˆ¶è®¾ç½®æ¨¡æ€æ¡†å†…å®¹å±‚çº§
        const modalContents = document.querySelectorAll('.modal-content');
        modalContents.forEach(content => {
            content.style.pointerEvents = 'auto';
            content.style.zIndex = '10000';
            content.style.position = 'relative';
            console.log('è®¾ç½®modal-content z-index: 10000');
        });
        
        // æ–¹æ³•4: ç¡®ä¿æ‰€æœ‰æŒ‰é’®å¯ç‚¹å‡»
        const buttons = document.querySelectorAll('.modal .btn');
        buttons.forEach(button => {
            button.style.pointerEvents = 'auto';
            button.style.zIndex = '10001';
            button.style.position = 'relative';
        });
        
        // æ–¹æ³•5: å¦‚æœè¿˜æ˜¯ä¸è¡Œï¼Œç›´æ¥ç¦ç”¨backdrop
        setTimeout(() => {
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => {
                backdrop.style.display = 'none';
                console.log('å®Œå…¨éšè—backdrop');
            });
        }, 100);
        
        console.log('æ¨¡æ€æ¡†ä¿®å¤å®Œæˆ');
    }
    
    // è‡ªå®šä¹‰æ¨¡æ€æ¡†æ§åˆ¶å‡½æ•°
    function showWalletModal() {
        walletModalElement.style.display = 'block';
        document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
    }
    
    function hideWalletModal() {
        walletModalElement.style.display = 'none';
        document.body.style.overflow = 'auto'; // æ¢å¤æ»šåŠ¨
    }
    
    // é’±åŒ…è¿æ¥äº‹ä»¶
    connectWalletBtn.addEventListener('click', function() {
        console.log('è¿æ¥é’±åŒ…æŒ‰é’®è¢«ç‚¹å‡»');
        showWalletModal();
    });
    
    // å…³é—­æ¨¡æ€æ¡†äº‹ä»¶
    document.getElementById('closeWalletModal').addEventListener('click', hideWalletModal);
    document.getElementById('cancelWalletModal').addEventListener('click', hideWalletModal);
    
    // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
    walletModalElement.addEventListener('click', function(e) {
        if (e.target === walletModalElement) {
            hideWalletModal();
        }
    });
    
    // ESCé”®å…³é—­æ¨¡æ€æ¡†
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && walletModalElement.style.display === 'block') {
            hideWalletModal();
        }
    });
    
    connectMetaMaskBtn.addEventListener('click', function() {
        console.log('MetaMaskæŒ‰é’®è¢«ç‚¹å‡»');
        connectWallet('metamask');
    });
    
    connectOKXBtn.addEventListener('click', function() {
        console.log('OKXæŒ‰é’®è¢«ç‚¹å‡»');
        connectWallet('okx');
    });
    
    disconnectWalletBtn.addEventListener('click', function() {
        disconnectWallet();
    });
    
    // å–æ¶ˆç­¾åæŒ‰é’®
    cancelSignBtn.addEventListener('click', function() {
        signModal.hide();
    });
    
    // è‡ªå®šä¹‰æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬
    console.log('è‡ªå®šä¹‰é’±åŒ…æ¨¡æ€æ¡†å·²åˆå§‹åŒ–');
    
    signModalElement.addEventListener('shown.bs.modal', function() {
        console.log('ç­¾åæ¨¡æ€æ¡†å·²æ˜¾ç¤º');
        fixModalClick();
    });
    
    signModalElement.addEventListener('hidden.bs.modal', function() {
        console.log('ç­¾åæ¨¡æ€æ¡†å·²å…³é—­');
    });
    
    // åˆå§‹åŒ–æ—¶æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
    if (authToken) {
        verifyToken();
    }
    
    // é’±åŒ…è¿æ¥å‡½æ•°
    async function connectWallet(walletType) {
        try {
            // å…ˆå…³é—­é’±åŒ…é€‰æ‹©æ¨¡æ€æ¡†
            hideWalletModal();
            
            // æ£€æŸ¥é’±åŒ…æ˜¯å¦å¯ç”¨
            if (walletType === 'metamask' && !window.ethereum) {
                showError('è¯·å®‰è£…MetaMaské’±åŒ…');
                return;
            }
            
            if (walletType === 'okx' && !window.okxwallet) {
                showError('è¯·å®‰è£…OKXé’±åŒ…');
                return;
            }
            
            // è¿æ¥é’±åŒ…
            const provider = walletType === 'metamask' ? window.ethereum : window.okxwallet;
            const accounts = await provider.request({ method: 'eth_requestAccounts' });
            
            if (accounts.length === 0) {
                showError('æœªè·å–åˆ°é’±åŒ…è´¦æˆ·');
                return;
            }
            
            currentAccount = accounts[0];
            currentWallet = walletType;
            
            // è·å–é“¾ID
            const chainId = await provider.request({ method: 'eth_chainId' });
            const chainIdNumber = parseInt(chainId, 16);
            
            // å¼€å§‹è®¤è¯æµç¨‹
            await authenticateWallet(currentAccount, walletType, chainIdNumber);
            
        } catch (error) {
            console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error);
            showError('è¿æ¥é’±åŒ…å¤±è´¥: ' + error.message);
        }
    }
    
    // é’±åŒ…è®¤è¯å‡½æ•°
    async function authenticateWallet(address, walletType, chainId) {
        try {
            // 1. è·å–éšæœºæ•°
            const nonceResponse = await fetch('/api/auth/nonce', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    wallet_address: address
                })
            });
            
            const nonceData = await nonceResponse.json();
            if (!nonceData.success) {
                throw new Error(nonceData.error);
            }
            
            // 2. æ˜¾ç¤ºç­¾åæ¨¡æ€æ¡†
            signModal.show();
            
            // 3. è¯·æ±‚ç”¨æˆ·ç­¾å
            const provider = walletType === 'metamask' ? window.ethereum : window.okxwallet;
            const signature = await provider.request({
                method: 'personal_sign',
                params: [nonceData.data.message, address]
            });
            
            // 4. éªŒè¯ç­¾å
            const verifyResponse = await fetch('/api/auth/verify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    wallet_address: address,
                    signature: signature,
                    nonce: nonceData.data.nonce,
                    wallet_type: walletType,
                    chain_id: chainId
                })
            });
            
            const verifyData = await verifyResponse.json();
            if (!verifyData.success) {
                throw new Error(verifyData.error);
            }
            
            // 5. ä¿å­˜è®¤è¯ä¿¡æ¯
            authToken = verifyData.data.token;
            localStorage.setItem('authToken', authToken);
            
            // 6. æ›´æ–°UI
            signModal.hide();
            updateWalletUI(address, verifyData.data.user);
            
            showSuccess('é’±åŒ…è¿æ¥æˆåŠŸï¼');
            
        } catch (error) {
            console.error('é’±åŒ…è®¤è¯å¤±è´¥:', error);
            signModal.hide();
            showError('é’±åŒ…è®¤è¯å¤±è´¥: ' + error.message);
        }
    }
    
    // éªŒè¯token
    async function verifyToken() {
        try {
            const response = await fetch('/api/auth/profile', {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            
            const data = await response.json();
            if (data.success) {
                currentAccount = data.data.wallet_address;
                currentWallet = data.data.wallet_type;
                updateWalletUI(data.data.wallet_address, data.data);
            } else {
                // Tokenæ— æ•ˆï¼Œæ¸…é™¤æœ¬åœ°å­˜å‚¨
                localStorage.removeItem('authToken');
                authToken = null;
            }
        } catch (error) {
            console.error('éªŒè¯tokenå¤±è´¥:', error);
            localStorage.removeItem('authToken');
            authToken = null;
        }
    }
    
    // æ–­å¼€é’±åŒ…è¿æ¥
    function disconnectWallet() {
        currentWallet = null;
        currentAccount = null;
        authToken = null;
        localStorage.removeItem('authToken');
        
        // æ›´æ–°UI
        connectWalletBtn.classList.remove('d-none');
        walletInfo.classList.add('d-none');
        
        showSuccess('é’±åŒ…å·²æ–­å¼€è¿æ¥');
    }
    
    // æ›´æ–°é’±åŒ…UI
    function updateWalletUI(address, userData) {
        const shortAddress = `${address.slice(0, 6)}...${address.slice(-4)}`;
        walletAddress.textContent = shortAddress;
        walletAddress.title = address;
        
        connectWalletBtn.classList.add('d-none');
        walletInfo.classList.remove('d-none');
    }
    
    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
    function showError(message) {
        // åˆ›å»ºé”™è¯¯æç¤ºå…ƒç´ 
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
        errorDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        errorDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(errorDiv);
        
        // 5ç§’åè‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.remove();
            }
        }, 5000);
    }
    
    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    function showSuccess(message) {
        // åˆ›å»ºæˆåŠŸæç¤ºå…ƒç´ 
        const successDiv = document.createElement('div');
        successDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
        successDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        successDiv.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(successDiv);
        
        // 3ç§’åè‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.remove();
            }
        }, 3000);
    }
    
    // ==================== ä¼šè¯ç®¡ç†å‡½æ•° ====================
    
    // åˆå§‹åŒ–ä¼šè¯ç®¡ç†
    function initializeSessionManagement() {
        loadSessions().then(() => {
            // å¦‚æœæœ‰å†å²ä¼šè¯ï¼ŒåŠ è½½æœ€æ–°çš„ä¼šè¯ï¼›å¦åˆ™åˆ›å»ºæ–°ä¼šè¯
            if (sessions.length > 0) {
                // æ‰¾åˆ°æœ€æ–°çš„ä¼šè¯ï¼ˆæŒ‰last_message_atæˆ–created_atæ’åºï¼‰
                const latestSession = sessions.reduce((latest, current) => {
                    const latestTime = new Date(latest.last_message_at || latest.created_at);
                    const currentTime = new Date(current.last_message_at || current.created_at);
                    return currentTime > latestTime ? current : latest;
                });
                switchToSession(latestSession.session_id);
                console.log('åŠ è½½æœ€æ–°ä¼šè¯:', latestSession.title);
            } else {
                // æ²¡æœ‰å†å²ä¼šè¯ï¼Œåˆ›å»ºæ–°ä¼šè¯
                createNewSession();
                console.log('åˆ›å»ºæ–°ä¼šè¯');
            }
        });
    }
    
    // åŠ è½½ä¼šè¯åˆ—è¡¨
    function loadSessions() {
        return fetch('/api/sessions', {
            headers: {
                'Authorization': authToken ? `Bearer ${authToken}` : ''
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                sessions = data.data.sessions;
                renderSessionList();
                return sessions;
            } else {
                console.error('åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:', data.error);
                return [];
            }
        })
        .catch(error => {
            console.error('åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
            return [];
        });
    }
    
    // åŠ è½½ä¼šè¯è¯¦ç»†ä¿¡æ¯
    function loadSessionDetails(sessionId) {
        return fetch(`/api/sessions/${sessionId}`, {
            headers: {
                'Authorization': authToken ? `Bearer ${authToken}` : ''
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentSession = data.data;
                // å¦‚æœä¼šè¯ä¸åœ¨æœ¬åœ°åˆ—è¡¨ä¸­ï¼Œæ·»åŠ åˆ°åˆ—è¡¨ä¸­
                if (!sessions.find(s => s.session_id === sessionId)) {
                    sessions.unshift(currentSession);
                }
                return currentSession;
            } else {
                console.error('åŠ è½½ä¼šè¯è¯¦æƒ…å¤±è´¥:', data.error);
                return null;
            }
        })
        .catch(error => {
            console.error('åŠ è½½ä¼šè¯è¯¦æƒ…å¤±è´¥:', error);
            return null;
        });
    }
    
    // æ¸²æŸ“ä¼šè¯åˆ—è¡¨
    function renderSessionList() {
        sessionItems.innerHTML = '';
        
        if (sessions.length === 0) {
            sessionItems.innerHTML = '<div class="text-muted text-center py-3">æš‚æ— ä¼šè¯è®°å½•</div>';
            return;
        }
        
        sessions.forEach(session => {
            const sessionItem = createSessionItem(session);
            sessionItems.appendChild(sessionItem);
        });
    }
    
    // åˆ›å»ºä¼šè¯é¡¹ç›®
    function createSessionItem(session) {
        const item = document.createElement('div');
        item.className = `session-item p-2 mb-2 rounded cursor-pointer ${session.session_id === currentSessionId ? 'bg-primary text-white' : 'bg-white border'}`;
        item.dataset.sessionId = session.session_id;
        
        const title = session.title || 'æ–°å¯¹è¯';
        const lastMessage = session.last_message_at ? new Date(session.last_message_at).toLocaleDateString() : '';
        
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="fw-bold text-truncate" style="max-width: 200px;" title="${title}">${title}</div>
                    <small class="text-muted">${lastMessage}</small>
                </div>
                <div class="session-actions">
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSession('${session.session_id}', event)" title="åˆ é™¤ä¼šè¯">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        item.addEventListener('click', function(e) {
            if (!e.target.closest('.session-actions')) {
                switchToSession(session.session_id);
            }
        });
        
        return item;
    }
    
    // åˆ›å»ºæ–°ä¼šè¯
    function createNewSession() {
        fetch('/api/sessions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': authToken ? `Bearer ${authToken}` : ''
            },
            body: JSON.stringify({
                title: 'æ–°å¯¹è¯'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const newSession = data.data;
                sessions.unshift(newSession);
                switchToSession(newSession.session_id);
                renderSessionList();
            }
        })
        .catch(error => {
            console.error('åˆ›å»ºä¼šè¯å¤±è´¥:', error);
            // å¦‚æœAPIå¤±è´¥ï¼Œåˆ›å»ºä¸´æ—¶ä¼šè¯
            const tempSessionId = 'temp_' + Date.now();
            switchToSession(tempSessionId);
        });
    }
    
    // åˆ‡æ¢åˆ°æŒ‡å®šä¼šè¯
    function switchToSession(sessionId) {
        // ç¦»å¼€ä¹‹å‰çš„ä¼šè¯æˆ¿é—´
        if (currentSessionId) {
            socket.emit('leave_session', { session_id: currentSessionId });
        }
        
        currentSessionId = sessionId;
        currentSession = sessions.find(s => s.session_id === sessionId);
        
        // å¦‚æœä¼šè¯ä¸åœ¨æœ¬åœ°åˆ—è¡¨ä¸­ï¼Œä»æœåŠ¡å™¨è·å–å®Œæ•´ä¿¡æ¯
        if (!currentSession) {
            loadSessionDetails(sessionId).then(() => {
                // åŠ å…¥æ–°çš„ä¼šè¯æˆ¿é—´
                socket.emit('join_session', { session_id: sessionId });
                
                // æ›´æ–°UI
                updateSessionUI();
                
                // åŠ è½½ä¼šè¯æ¶ˆæ¯
                loadSessionMessages(sessionId);
                
                // é‡æ–°æ¸²æŸ“ä¼šè¯åˆ—è¡¨ï¼ˆæ›´æ–°é€‰ä¸­çŠ¶æ€ï¼‰
                renderSessionList();
            });
        } else {
            // åŠ å…¥æ–°çš„ä¼šè¯æˆ¿é—´
            socket.emit('join_session', { session_id: sessionId });
            
            // æ›´æ–°UI
            updateSessionUI();
            
            // åŠ è½½ä¼šè¯æ¶ˆæ¯
            loadSessionMessages(sessionId);
            
            // é‡æ–°æ¸²æŸ“ä¼šè¯åˆ—è¡¨ï¼ˆæ›´æ–°é€‰ä¸­çŠ¶æ€ï¼‰
            renderSessionList();
        }
    }
    
    // æ›´æ–°ä¼šè¯UI
    function updateSessionUI() {
        if (currentSession) {
            currentSessionTitle.innerHTML = `
                <i class="fas fa-robot text-primary me-2"></i>
                ${currentSession.title || 'AI Agent æ™ºèƒ½åŠ©æ‰‹'}
            `;
            sessionSettingsBtn.style.display = 'inline-block';
            clearChatBtn.style.display = 'inline-block';
        } else {
            currentSessionTitle.innerHTML = `
                <i class="fas fa-robot text-primary me-2"></i>
                AI Agent æ™ºèƒ½åŠ©æ‰‹
            `;
            sessionSettingsBtn.style.display = 'none';
            clearChatBtn.style.display = 'none';
        }
    }
    
    // åŠ è½½ä¼šè¯æ¶ˆæ¯
    function loadSessionMessages(sessionId) {
        // æ¸…ç©ºå½“å‰èŠå¤©åŒºåŸŸ
        clearChatArea();
        
        // å¦‚æœæ˜¯ä¸´æ—¶ä¼šè¯æˆ–æ²¡æœ‰æ¶ˆæ¯ï¼Œæ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
        if (!currentSession || !currentSession.messages || currentSession.messages.length === 0) {
            showWelcomeMessage();
            return;
        }
        
        console.log(`åŠ è½½ä¼šè¯ ${sessionId} çš„æ¶ˆæ¯ï¼Œå…± ${currentSession.messages.length} æ¡`);
        
        // åŠ è½½å†å²æ¶ˆæ¯
        currentSession.messages.forEach((message, index) => {
            try {
                let metadata = null;
                if (message.metadata) {
                    try {
                        metadata = JSON.parse(message.metadata);
                    } catch (e) {
                        console.warn('è§£ææ¶ˆæ¯å…ƒæ•°æ®å¤±è´¥:', e);
                    }
                }
                addMessage(message.content, message.message_type, metadata);
            } catch (error) {
                console.error(`åŠ è½½ç¬¬ ${index + 1} æ¡æ¶ˆæ¯å¤±è´¥:`, error);
            }
        });
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        chatArea.scrollTop = chatArea.scrollHeight;
    }
    
    // æ¸…ç©ºèŠå¤©åŒºåŸŸ
    function clearChatArea() {
        const welcomeMessage = document.getElementById('welcomeMessage');
        if (welcomeMessage) {
            welcomeMessage.remove();
        }
        
        const messages = chatArea.querySelectorAll('.message');
        messages.forEach(msg => msg.remove());
    }
    
    // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
    function showWelcomeMessage() {
        const welcomeDiv = document.createElement('div');
        welcomeDiv.className = 'message ai-message';
        welcomeDiv.id = 'welcomeMessage';
        welcomeDiv.innerHTML = `
            <div class="message-content">
                <i class="fas fa-robot me-2"></i>
                <div class="markdown-content">
                    # æ‚¨å¥½ï¼æˆ‘æ˜¯AIæ™ºèƒ½åŠ©æ‰‹ ğŸ¤–
                    
                    æˆ‘å¯ä»¥å¸®æ‚¨å›ç­”é—®é¢˜ï¼Œå¹¶æ ¹æ®é—®é¢˜çš„éœ€è¦è‡ªåŠ¨è¿›è¡Œè”ç½‘æœç´¢æ¥è·å–æœ€æ–°ä¿¡æ¯ã€‚
                    
                    ## åŠŸèƒ½ç‰¹ç‚¹
                    
                    - **æ™ºèƒ½åˆ¤æ–­**ï¼šè‡ªåŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦è”ç½‘æœç´¢
                    - **å¤šå¼•æ“æœç´¢**ï¼šæ”¯æŒDuckDuckGoå’ŒGoogleæœç´¢
                    - **å†…å®¹åˆ†æ**ï¼šè‡ªåŠ¨çˆ¬å–ç½‘é¡µå†…å®¹è¿›è¡Œåˆ†æ
                    - **å‡†ç¡®å›ç­”**ï¼šæä¾›å‡†ç¡®ã€åŠæ—¶çš„å›ç­”
                    - **ä¼šè¯ç®¡ç†**ï¼šæ”¯æŒå¤šä¼šè¯å†å²è®°å½•
                    
                    ## ä½¿ç”¨æç¤º
                    
                    æ‚¨å¯ä»¥é—®æˆ‘ä»»ä½•é—®é¢˜ï¼Œæ¯”å¦‚ï¼š
                    - æœ€æ–°çš„æ–°é—»èµ„è®¯
                    - æŠ€æœ¯é—®é¢˜è§£ç­”
                    - å®æ—¶æ•°æ®æŸ¥è¯¢
                    - å†å²çŸ¥è¯†é—®ç­”
                </div>
            </div>
        `;
        chatArea.appendChild(welcomeDiv);
    }
    
    // æ¸…ç©ºå½“å‰ä¼šè¯
    function clearCurrentSession() {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰ä¼šè¯çš„æ‰€æœ‰æ¶ˆæ¯å—ï¼Ÿ')) {
            clearChatArea();
            showWelcomeMessage();
            
            // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œè°ƒç”¨APIæ¸…ç©ºä¼šè¯
            if (authToken && currentSession) {
                // è¿™é‡Œå¯ä»¥æ·»åŠ æ¸…ç©ºä¼šè¯çš„APIè°ƒç”¨
                console.log('æ¸…ç©ºä¼šè¯:', currentSessionId);
            }
        }
    }
    
    // åˆ é™¤ä¼šè¯
    function deleteSession(sessionId, event) {
        event.stopPropagation();
        
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¼šè¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
            if (authToken) {
                fetch(`/api/sessions/${sessionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // ä»åˆ—è¡¨ä¸­ç§»é™¤
                        sessions = sessions.filter(s => s.session_id !== sessionId);
                        renderSessionList();
                        
                        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä¼šè¯ï¼Œåˆ›å»ºæ–°ä¼šè¯
                        if (currentSessionId === sessionId) {
                            createNewSession();
                        }
                    }
                })
                .catch(error => {
                    console.error('åˆ é™¤ä¼šè¯å¤±è´¥:', error);
                });
            } else {
                // æœªç™»å½•ç”¨æˆ·ï¼Œç›´æ¥ä»åˆ—è¡¨ä¸­ç§»é™¤
                sessions = sessions.filter(s => s.session_id !== sessionId);
                renderSessionList();
                
                if (currentSessionId === sessionId) {
                    createNewSession();
                }
            }
        }
    }
    
    
    // èšç„¦è¾“å…¥æ¡†
    questionInput.focus();
});
</script>
{% endblock %}
